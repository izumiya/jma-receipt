#! /bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

umask 022

PATH=$PATH:/usr/lib/postgresql/bin

ORCAUSER=orca
ORCAGROUP=orca
LOGDIR=/var/log/jma-receipt

INSTALLLOG="$LOGDIR"/orca-db-install-@VERSION@.log

if [ ! -d "$LOGDIR" ]
then
  mkdir "$LOGDIR"
  chown "$ORCAUSER":"$ORCAGROUP" "$LOGDIR"
fi

if [ ! -e "$INSTALLLOG" ]; then
  su - orca -c "touch $INSTALLLOG" 
fi

if su - postgres -c "psql template1 -l|grep ${DBNAME}"
then
	if [ -f $PATCHDIR/copying ];	then
		echo "更新プログラム管理テーブルクリア処理スキップ" 2>&1 | tee -a $INSTALLLOG
	else
		echo "更新プログラム管理テーブルクリア処理開始" 2>&1 | tee -a $INSTALLLOG
		echo "delete from tbl_pgkanri ;" | su - orca -c "psql -e orca 2>&1 | tee -a $INSTALLLOG"
	fi 
fi
echo "Done."
