#! /bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

err () {
  MSG=$1
  NUM=$2
  delete_pgpass
  echo "ERROR: ${MSG}" | tee -a $INSTALLLOG
  exit ${NUM}
}

create_pgpass
DBKANRISQL="SELECT count(*) FROM pg_tables WHERE tablename = 'tbl_dbkanri';"
DBKANRICHECK=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -At ${DBNAME} -c \"${DBKANRISQL}\""`
if [ $? -ne 0 ] || [ "$DBKANRICHECK" -eq 0 ]; then
    DBKANRI=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -q --set \"ON_ERROR_STOP=1\" ${DBNAME} -f ${INITDIR}/orca_dbkanri_orig.dump" 2>&1`
    RC=$?
    if [ $RC -ne 0 ] ; then
	echo $DBKANRI
	err "${INITDIR}/orca_dbkanri_orig.dump が処理出来ませんでした" 99
    fi
    echo "${INITDIR}/orca_dbkanri_orig.dump done." | tee -a  $INSTALLLOG
fi
delete_pgpass
exit 0
