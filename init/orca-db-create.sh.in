#! /bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

ORCAUSER=orca
ORCAGROUP=orca
LOGDIR=/var/log/jma-receipt

DBUSER="orca"
USERCHECKSQL="SELECT usename FROM pg_user WHERE usename = '${DBUSER}';"
DBCHECKSQL="SELECT datname FROM pg_database WHERE datname = '${DBNAME}';"
LOCALECHECKSQL="SELECT setting FROM pg_settings WHERE name = 'lc_collate';"

INSTALLLOG="$LOGDIR"/orca-db-install-@VERSION@.log

if [ ! -d "$LOGDIR" ]
then
  mkdir "$LOGDIR"
  chown "$ORCAUSER":"$ORCAGROUP" "$LOGDIR"
fi

if [ ! -e "$INSTALLLOG" ]; then
  su - orca -c "touch $INSTALLLOG" 
fi

if test  X`su - postgres -c "psql template1 -t -P format=unaligned -c \"${LOCALECHECKSQL}\""` != "XC"
then
    echo "Error, PostgreSQL locale should be C. " | tee -a $INSTALLLOG
    echo "Please set locale C and execute initdb or createcluster. " | tee -a $INSTALLLOG
    exit 1
fi

if [ -z `su - postgres -c "psql template1 -t -c \"${USERCHECKSQL}\""` ]
then
  if [ "`createuser --version|sed -e 's/createuser (PostgreSQL) \([0-9]*\)\.[0-9]*\.[0-9]*/\1/'`" -ge 8 ]
  then
    su - postgres -c "createuser --createdb --no-superuser --no-createrole ${DBUSER}" 
  else
    su - postgres -c "createuser --createdb --no-adduser ${DBUSER}" 
  fi
fi

if [ -z `su - postgres -c "psql template1 -t -c \"${DBCHECKSQL}\""` ]
then
    su - ${DBUSER} -c "createdb -EEUC_JP \"${DBNAME}\"" 
    su - ${DBUSER} -c "psql -e ${DBNAME} < ${INITDIR}/orca_dbkanri_orig.dump 2>&1 | tee -a $INSTALLLOG"
    su - ${DBUSER} -c "psql -e ${DBNAME} < ${INITDIR}/orca_mstkanri_orig.dump 2>&1 | tee -a $INSTALLLOG"
else
    echo "Database exist." 2>&1 | tee -a $INSTALLLOG
fi
echo "Done."
