#! /bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

LOGDIR=/var/log/jma-receipt


if [ -z "$DBENCODING" ]
then
    DBENCODING="EUC-JP"
fi
USERCHECKSQL="SELECT usename FROM pg_user WHERE usename = '${DBUSER}';"
DBCHECKSQL="SELECT datname FROM pg_database WHERE datname = '${DBNAME}';"

INSTALLLOG="$LOGDIR"/orca-db-install-@VERSION@.log

if [ ! -d "$LOGDIR" ]
then
    mkdir "$LOGDIR"
    chown "$ORCAUSER":"$ORCAGROUP" "$LOGDIR"
fi

if [ ! -e "$INSTALLLOG" ]; then
    su - $ORCAUSER -c "touch $INSTALLLOG"
fi

if [ -z `su - postgres -c "psql template1 ${PSQLOPTION} -t -c \"${USERCHECKSQL}\""` ]
then
    su - postgres -c "createuser --createdb --no-superuser --no-createrole ${DBUSER}"
fi

if [ -z `su - postgres -c "psql template1 ${PSQLOPTION} -t -c \"${DBCHECKSQL}\""` ]
then
    su - ${ORCAUSER} -c "createdb -lC -Ttemplate0 -E${DBENCODING} \"${DBNAME}\""
    su - ${ORCAUSER} -c "psql ${PSQLOPTION} -e ${DBNAME} < ${INITDIR}/orca_dbkanri_orig.dump 2>&1 | tee -a $INSTALLLOG"
else
    echo "Database exist." 2>&1 | tee -a $INSTALLLOG
fi
echo "Done."
