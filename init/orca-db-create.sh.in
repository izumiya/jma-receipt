#! /bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

err () {
  MSG=$1
  NUM=$2
  delete_pgpass
  echo "ERROR: ${MSG}" | tee -a $INSTALLLOG
  exit ${NUM}
}

create_pgpass
if [ -z "$DBENCODING" ]
then
    DBENCODING="EUC-JP"
fi
USERCHECKSQL="SELECT usename FROM pg_user WHERE usename = '${DBUSER}';"
DBCHECKSQL="SELECT datname FROM pg_database WHERE datname = '${DBNAME}';"
SETPASSWORD="ALTER USER ${DBUSER} password '${DBPASS}';"
INSTALLLOG="$LOGDIR"/orca-db-install-@VERSION@.log
ENCODINGCHECK="SELECT pg_encoding_to_char(encoding) FROM pg_database WHERE datname = '${DBNAME}';"

if [ ! -e "$INSTALLLOG" ]; then
    su - $ORCAUSER -c "touch $INSTALLLOG"
fi

# USER
if [ x"$DBHOST" = "x" ]; then
    # localhost("")
    if [ -z `su - postgres -c "psql ${DBCONNOPTION} template1 -t -c \"${USERCHECKSQL}\""` ]
    then
	su - postgres -c "createuser ${DBCONNOPTION} --createdb --no-superuser --no-createrole ${DBUSER}"
	if [ $? -ne 0 ] ; then
	    err "createuser error (${DBUSER})" 99
	fi
    fi
else
    # remote host
    if [ x"$PGPASS" != "x" ]; then
	USEREXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} template1 -t -c \"${USERCHECKSQL}\""`
	RC=$?
	if [ -z $USEREXIST ] || [ $RC -ne 0 ] ; then
	    su - ${ORCAUSER} -c "createuser ${DBCONNOPTION} -U postgres --createdb --no-superuser --no-createrole ${DBUSER}"
	    if [ $? -ne 0 ] ; then
		err "createuser error(${DBUSER})" 99
	    fi
	    echo "CREATEUSER (${DBUSER})" | tee -a  $INSTALLLOG
	    if [ $? -ne 0 ] ; then
		err "set password error"  99
	    fi
	    su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -U postgres -c \"${SETPASSWORD}\""
	fi
    fi
fi

# DB
DBEXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} template1 -t -c \"${DBCHECKSQL}\""`
RC=$?
if [ ! -z $DBEXIST ] ; then
    DBEXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -t -c \"${DBCHECKSQL}\""`
    RC=$?
fi
if [ $RC -ne 0 ] ; then
    err "database check error (${DBCHECKSQL})" 99
fi
if [ -z $DBEXIST ] ; then
    su - ${ORCAUSER} -c "createdb ${DBCONNOPTION} -lC -Ttemplate0 -E${DBENCODING} \"${DBNAME}\""
    if [ $? -ne 0 ] ; then
	err "createdb error (${DBNAME})" 99
    fi
    echo "CREATEDB (${DBNAME})" | tee -a  $INSTALLLOG
else
    ORCAENCODING=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -t -c \"${ENCODINGCHECK}\""`
    if [ $? -ne 0 ] ; then
	err "encoding error (${DBNAME})" 99
    fi
    if [ $DBENCODING = "UTF-8" ] || [ $DBENCODING = "UTF8" ] || [ $DBENCODING = "utf-8" ] || [ $DBENCODING = "utf8" ] ; then
	if [ $ORCAENCODING != "UTF8" ]; then
	    err "encoding error Database(${ORCAENCODING}) != DBENCODING(${DBENCODING})" 98
	fi
    else
	if [ $ORCAENCODING != "EUC_JP" ]; then
	    err "encoding error Database(${ORCAENCODING}) != DBENCODING(${DBENCODING})" 98
	fi
    fi
fi
delete_pgpass
exit 0
