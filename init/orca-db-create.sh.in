#! /bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

err () {
  MSG=$1
  NUM=$2
  delete_pgpass
  echo "ERROR: ${MSG}" | tee -a $INSTALLLOG
  exit ${NUM}
}

create_pgpass
if [ -z "$DBENCODING" ]
then
    DBENCODING="EUC-JP"
fi
USERCHECKSQL="SELECT usename FROM pg_user WHERE usename = '${DBUSER}';"
DBCHECKSQL="SELECT datname FROM pg_database WHERE datname = '${DBNAME}';"
SETPASSWORD="ALTER USER ${DBUSER} password '${DBPASS}';"
DBKANRISQL="SELECT count(*) FROM pg_tables WHERE tablename = 'tbl_dbkanri';"
INSTALLLOG="$LOGDIR"/orca-db-install-@VERSION@.log

if [ ! -e "$INSTALLLOG" ]; then
    su - $ORCAUSER -c "touch $INSTALLLOG"
fi

# USER
if [ x"$DBHOST" = "x" ]; then
    # localhost("")
    if [ -z `su - postgres -c "psql ${DBCONNOPTION} template1 -t -c \"${USERCHECKSQL}\""` ]
    then
	su - postgres -c "createuser ${DBCONNOPTION} --createdb --no-superuser --no-createrole ${DBUSER}"
	if [ $? -ne 0 ] ; then
	    err "createuser error (${DBUSER})" 99
	fi
    fi
else
    # remote host
    if [ x"$PGPASS" != "x" ]; then
	USEREXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} template1 -t -c \"${USERCHECKSQL}\""`
	RC=$?
	if [ -z $USEREXIST ] || [ $RC -ne 0 ] ; then
	    su - ${ORCAUSER} -c "createuser ${DBCONNOPTION} -U postgres --createdb --no-superuser --no-createrole ${DBUSER}"
	    if [ $? -ne 0 ] ; then
		err "createuser error(${DBUSER})" 99
	    fi
	    echo "CREATEUSER (${DBUSER})" | tee -a  $INSTALLLOG
	    if [ $? -ne 0 ] ; then
		err "set password error"  99
	    fi
	    su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -U postgres -c \"${SETPASSWORD}\""
	fi
    fi
fi

# DB
DBEXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} template1 -t -c \"${DBCHECKSQL}\""`
RC=$?
if [ ! -z $DBEXIST ] ; then
    DBEXIST=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} ${DBNAME} -t -c \"${DBCHECKSQL}\""`
    RC=$?
fi
if [ $RC -ne 0 ] ; then
    err "database check error (${DBCHECKSQL})" 99
fi
if [ -z $DBEXIST ] ; then
    su - ${ORCAUSER} -c "createdb ${DBCONNOPTION} -lC -Ttemplate0 -E${DBENCODING} \"${DBNAME}\""
    if [ $? -ne 0 ] ; then
	err "createdb error (${DBNAME})" 99
    fi
    echo "CREATEDB (${DBNAME})" | tee -a  $INSTALLLOG
fi
DBKANRICHECK=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -At ${DBNAME} -c \"${DBKANRISQL}\""`
if [ $? -ne 0 ] || [ "$DBKANRICHECK" -eq 0 ]; then
    DBKANRI=`su - ${ORCAUSER} -c "psql ${DBCONNOPTION} -q --set \"ON_ERROR_STOP=1\" ${DBNAME} -f ${INITDIR}/orca_dbkanri_orig.dump" 2>&1`
    RC=$?
    if [ $RC -ne 0 ] ; then
	echo $DBKANRI
	err "${INITDIR}/orca_dbkanri_orig.dump が処理出来ませんでした" 99
    fi
    echo "${INITDIR}/orca_dbkanri_orig.dump done." | tee -a  $INSTALLLOG
fi
delete_pgpass
exit 0
