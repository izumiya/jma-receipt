#!/bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

VERSIONFL=${DOCDIR}/version

DBVERSIONSQL="SELECT version FROM tbl_dbkanri WHERE kanricd='ORCADB00';"

EXITMODE=code

FLAG=`id -u`

if [ "${LANG}" = "ja_JP.UTF-8" ] || [ "${LANG}" = "ja_JP.utf8" ]; then
    JMSG=1
else
    JMSG=0
fi

if [ ${FLAG} -ne 0 ] ; then
    if [ ${JMSG} -eq 1 ] ; then
        echo "ERROR: root権限で実行してください。"
    else
        echo "ERROR: mest be root permission."
    fi
    exit 1
fi

if [ -z $1 ] ; then
    EXITMODE=code
else
    EXITMODE=file
fi


VERLIST=`awk '/version/{gsub(/\t| |;/,""); print} ' $VERSIONFL`
VERDATA=`echo $VERLIST | awk '{i=split($0,arr,"("); print arr[i]} ' `
VERDATA1=`echo $VERDATA | awk '{gsub(/[-)]/,""); print } ' `

create_pgpass
DBVERSION=`su - $ORCAUSER -c "psql ${DBCONNOPTION} -At -c \"${DBVERSIONSQL}\" $DBNAME"`
RC=$?
delete_pgpass
if [ $RC -ne 0 ] || [ -z "$DBVERSION" ] ; then
    echo "ERROR: データベース管理情報が読み取れません。処理を中止します"
    exit 99
fi
DBVERSION1=`echo $DBVERSION | awk '{gsub(/[-)]/,""); print } ' `

echo
if [ `echo $DBVERSION1 $VERDATA1 | awk '{print($1==$2) ? "true" : "false"} '` = "true" ];	then
    echo "Very Good!"
    if [ -e "$SYSCONFDIR"/database-schema-different ] ; then
	rm -f "$SYSCONFDIR"/database-schema-different
    fi
else
    echo "package  version=" $VERDATA1
    echo "database version=" $DBVERSION1
    echo
    if [ ${JMSG} -eq 1 ] ; then
	echo "パッケージとデータベースのバージョンが不整合を起こしています。"
    else
	echo "No Good!"
    fi
    if [ "${EXITMODE}" = "file" ] ; then
	if ! [ -e "$SYSCONFDIR"/database-schema-different ] ; then
	    touch "$SYSCONFDIR"/database-schema-different
	fi
    else
	exit 99
    fi
fi

exit 0
