#!/bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

VERSIONFL=${DOCDIR}/version
DBKANRIFL=/tmp/jma-receipt-db-version

SQLSELECT="SELECT * FROM TBL_DBKANRI WHERE KANRICD='ORCADB00';"

EXITMODE=code

FLAG=`id -u`

if [ "${LANG}" = "ja_JP.UTF-8" ] || [ "${LANG}" = "ja_JP.utf8" ]; then
    JMSG=1
else
    JMSG=0
fi

if [ ${FLAG} -ne 0 ] ; then
    if [ ${JMSG} -eq 1 ] ; then
        echo "ERROR: root権限で実行してください。"
    else
        echo "ERROR: mest be root permission."
    fi
    exit 1
fi

if [ -z $1 ] ; then
    EXITMODE=code
else
    EXITMODE=file
fi

rm -f $DBKANRIFL

VERLIST=`awk '/version/{gsub(/\t| |;/,""); print} ' $VERSIONFL`
VERDATA=`echo $VERLIST | awk '{i=split($0,arr,"("); print arr[i]} ' `
VERDATA1=`echo $VERDATA | awk '{gsub(/[-)]/,""); print } ' `

#echo "VERDATA1=" $VERDATA1

create_pgpass
su - $ORCAUSER -c "psql $DBCONNOPTION -c \"$SQLSELECT\" -o $DBKANRIFL $DBNAME"
delete_pgpass

DBLIST=`awk '/--------|row/ {skip = ! skip; next};/};/ {exit}; (skip == 1) {gsub(/\t| |;/,""); print} ' $DBKANRIFL`

DBVERSION=`echo $DBLIST | awk '{i=split($0,arr,"|"); print arr[2]} ' `
DBVERSION1=`echo $DBVERSION | awk '{gsub(/[-)]/,""); print } ' `

echo
if [ `echo $DBVERSION1 $VERDATA1 | awk '{print($1==$2) ? "true" : "false"} '` = "true" ];	then
    echo "Very Good!"
    if [ -e "$SYSCONFDIR"/database-schema-different ] ; then
	rm -f "$SYSCONFDIR"/database-schema-different
    fi
else
    echo "package  version=" $VERDATA1
    echo "database version=" $DBVERSION1
    echo
    if [ ${JMSG} -eq 1 ] ; then
	echo "パッケージとデータベースのバージョンが不整合を起こしています。"
    else
	echo "No Good!"
    fi
    if [ "${EXITMODE}" = "file" ] ; then
	if ! [ -e "$SYSCONFDIR"/database-schema-different ] ; then
	    touch "$SYSCONFDIR"/database-schema-different
	fi
    else
	exit 99
    fi
fi

rm -f $DBKANRIFL
