#!/bin/bash
#
# Project code name "ORCA"
# 日医標準レセプトソフト(JMA standard receipt software)
#
# Copyright(C) 2002 JMA(Japan Medical Association)
#
# CREATE: 20060124
#
#
# データベース構造変更処理起動
#

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

CHANGE=$1
NOINST=$2

if [ "${LANG}" = "ja_JP.UTF-8" ] || [ "${LANG}" = "ja_JP.utf8" ]; then
    JMSG=1
else
    JMSG=0
fi

FLAG=`id -u`

if [ ${FLAG} -ne 0 ] ; then
    if [ ${JMSG} -eq 1 ] ; then
	echo "ERROR: root権限で実行してください。"
    else
    	echo "ERROR: must be root permission."
    fi
    exit 1
fi

# Check for echo -n vs echo \c
if echo '\c' | grep -s c >/dev/null
then
    ECHO_N="echo -n"
    ECHO_C=""
else
    ECHO_N="echo"
    ECHO_C='\c'
fi

#
if [ "$1" != "-y" -a "$1" != "-Y" ] ; then
    echo
    echo "version @VERSION@ データベース構造変更処理を行います。"
    if [ ${JMSG} -eq 1 ] ; then
	$ECHO_N "よろしいですか？ (y/n) "$ECHO_C
    else
	$ECHO_N "Are you sure? (y/n) "$ECHO_C
    fi
    read REPLY

    if [ "$?" -eq 1 ] ; then
	if [ ${JMSG} -eq 1 ] ; then
	    echo "NOTICE: ユーザにより処理をキャンセルされました。"
	else
    	    echo "NOTICE: user canceled."
	fi
	exit 1
    fi
    if [ "$REPLY" != "y" -a "$REPLY" != "Y" ] ; then
	if [ ${JMSG} -eq 1 ] ; then
	    echo "NOTICE: ユーザにより処理をキャンセルされました。"
	else
    	    echo "NOTICE: user canceled."
	fi
	exit 0
    fi
fi
#
# メイン処理
#

RC=0
echo "$INITDIR"/orca-db-create.sh ......
bash "$INITDIR"/orca-db-create.sh
RC=$?
if [ ${RC} -eq 0 ] ; then
    if [ x"$NOINST" = x"--noinstall" ] ; then
	echo "OK! データベースをリストア後再度 jma-setupを実行してください"
	exit 0
    fi
    echo "$INITDIR"/orca-db-init.sh .....
    bash "$INITDIR"/orca-db-init.sh
    RC=$?
fi
if [ ${RC} -eq 0 ] ; then
    echo "$INITDIR"/orca-db-install.sh .....
    bash "$INITDIR"/orca-db-install.sh
    RC=$?
fi
if [ ${RC} -eq 0 ] ; then
    if [ ! -f ${PGUP_PROOF} ];	then
        rm -fr ${PGUP_PROOF}
    fi
fi
if [ ${RC} -eq 0 ] ; then
    echo "$BINDIR"/jma-receipt-db-check.sh .....
    bash "$BINDIR"/jma-receipt-db-check.sh
    if [ $? -eq 0 ] ; then
	if [ -e "$SYSCONFDIR"/database-non-upgrade ] ; then
	    rm -f "$SYSCONFDIR"/database-non-upgrade
	fi
    fi
fi
#
# 処理終了
#
if [ ${JMSG} -eq 1 ] ; then
    if [ ${RC} -eq 0 ] ; then
	echo "データベース構造変更処理は終了しました"
    else
        echo "データベース構造変更処理は異常終了しました。"
    fi
else
    if [ ${RC} -eq 0 ] ; then
	echo "Done. Completed."
    else
        echo "Done. Incompleted."
    fi
fi
echo
exit ${RC}
