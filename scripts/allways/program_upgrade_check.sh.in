#!/bin/sh

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

umask 022

#------------------------------------
# $1 : 医療機関識別番号(HOSPNUM)
# $2 : スーパーバイザー
#------------------------------------

HOSPNUM=$1

HOME=/home/orca
PRGDIR=orca-prgupwork
PATCHDIR=/var/lib/jma-receipt/patch
LOGDIR=/var/log/jma-receipt
PACKAGEFILE=patch@VERSION@.gz

PRGPATH=$PGUPGRADEPATH/@VERSION@

LOG="$LOGDIR"/program_upgrade_check.log

# echo message (default character-code EUC)
function echomsg() {
  if [ "${LANG}" = "ja_JP.UTF-8" ] || [ "${LANG}" = "ja_JP.UTF8" ]; then
    echo `echo $1 | nkf -wE | tee -a $2`
  else
    echo $1 | tee -a $2
  fi
}

rm -f ${LOG}

#オフラインメンテナンスであるかチェック
OFFLINEPATH=`echo $PRGPATH | sed -ne 's#file://##p'`
if [ -z $OFFLINEPATH ]; then
  OFFLINE="online"
else
  OFFLINE="offline"
  PRGPATH=$OFFLINEPATH
fi
echomsg ${OFFLINE} ${LOG}

if ! [ -d $HOME/$PRGDIR ]; then 
  mkdir $HOME/$PRGDIR
fi
cd $HOME/$PRGDIR
rm -f $HOME/$PRGDIR/*

#更新プログラムダウンロード
ruby $SCRIPTSDIR/allways/cachedl.rb $PACKAGEFILE $PATCHDIR $PRGPATH $OFFLINE $WGETOPTION
if [ $? -ne 0 ] ; then
  echomsg "更新プログラムのダウンロードに失敗しました" ${LOG}
  rm -rf $HOME/$PRGDIR
  $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01,$HOSPNUM
  exit 99
fi

#アーカイブよりパッチプログラムを複写
ruby $SCRIPTSDIR/allways/cachetoprgdir.rb $PACKAGEFILE $PATCHDIR $HOME/$PRGDIR
if [ $? -ne 0 ] ; then
  echomsg "更新プログラムの複写に失敗しました" ${LOG}
  rm -rf $HOME/$PRGDIR
  $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01,$HOSPNUM
  exit 99
fi

#パッチプログラムチェック
ruby $SCRIPTSDIR/allways/program_upgrade_check.rb $PACKAGEFILE $PATCHDIR $HOME/$PRGDIR
if [ $? -ne 0 ]	; then 
  echomsg "更新プログラムのチェック処理が異常終了しました" ${LOG}
  rm -rf $HOME/$PRGDIR
  $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT98,$HOSPNUM
  exit 99
fi

echomsg "全ての処理が完了しました" ${LOG}

rm -rf $HOME/$PRGDIR
$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00,$HOSPNUM
