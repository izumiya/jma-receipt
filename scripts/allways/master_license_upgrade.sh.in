#!/bin/sh

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#------------------------------------
# $1 : 医療機関識別番号(HOSPNUM)
# $2 : スーパーバイザー
# $3 : 医療機関識別番号(HOSPID)
#------------------------------------

HOSPNUM=$1

HOME=/var/lib/jma-receipt/master
MSTDIR=lics-$(date +%Y%m%d)
WGETRCFL=/tmp/.wgetrc.license-master
LIUPWD=$3

KANRIFILE=ORCADBR-LI.DAT
UPDKANRIFILE=info/$KANRIFILE

UPDFILE=$HOME/$HOSPNUM/$MSTDIR/ORCADBR.OUT
LEN=100

function orcawget () {
#受信ファイル削除
	if [	-e	$1	]
	then
#	echo "rm start" $1
		rm $1;
	fi
	echo "http_user="${LIUPWD:0:5} > $WGETRCFL
	echo "http_passwd="${LIUPWD:0:5} >> $WGETRCFL
	export WGETRC=$WGETRCFL
	wget -q $WGETOPTION $DBLICENSEPATH/$1
#接続確認
	if [ $? -eq 0 ]	;	then 
#	echo "wget end OK"
		rm  $WGETRCFL
		return 0;
	else
		rm  $WGETRCFL
		return 1;
	fi
#ファイルサイズチェック
	if [	-s	$1	]
	then
		return 0;
	else
		return 1;
	fi
}

function orcatar () {
	TARFL=`echo $1 | awk '{i=split($0,arr,"/"); print arr[i]} ' `
	TAR=`echo $TARFL | awk '{i=split($0,arr,"."); print arr[i-1] arr[i]} ' `
	LOCALFL=`echo $TARFL | awk '{i=split($0,arr,"."); print arr[1]".dat"} ' ` 
	echo $LOCALFL "LOCALFL"
	echo $TARFL "TARFL"
#受信ファイル削除
	echo $1
	if [	$TAR = "targz" ]
	then
		echo $TAR "TAR"
		tar zxf $TARFL
		echo $TAR "END"
	else
		echo "NO tar end"
		return 0;
	fi
#tar確認
	if [ $? -eq 0 ]	;	then 
		echo "tar end OK"
	else
		echo "tar end NG"
		return 1;
	fi
#ファイルサイズチェック
	if [	-s	$LOCALFL	]
	then
		return 0;
	else
		return 1;
	fi
}

#オフラインメンテナンスであるかチェック
OFFLINEPATH=`echo $DBLICENSEPATH | sed -ne 's#file://##p'`
if [ -z $OFFLINEPATH ]; then
    OFFLINE="online"
else
    OFFLINE="offline"
fi

echo $MSTDIR
echo $UPDFILE
if ! [	-d	$HOME/$HOSPNUM	];	then 
	cd $HOME
	mkdir $HOSPNUM
fi
if ! [	-d	$HOME/$HOSPNUM/$MSTDIR	];	then 
	cd $HOME/$HOSPNUM
	mkdir $MSTDIR
fi
if ! [	-d	$HOME/$HOSPNUM/orca-mstlog	];	then 
	cd $HOME/$HOSPNUM
	mkdir orca-mstlog 
fi
cd $HOME/$HOSPNUM/$MSTDIR
rm -f *.*
if  [ $OFFLINE = "offline" ]; then
    if  [ -e $OFFLINEPATH/$UPDKANRIFILE ]; then
	cp $OFFLINEPATH/$UPDKANRIFILE ./
	echo "DBレコード管理情報を複写しました"
    else
	echo "DBレコード管理情報がありませんでした"
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
	exit 99
    fi
else
#センタからのDB構造体ダウンロード
    if	orcawget $UPDKANRIFILE ;	then
	echo "センタからのDBレコード管理情報のダウンロードが終了しました"
    else
	echo "センタからのDBレコード管理情報のダウンロードに失敗しました"
	rm -r $HOME/$HOSPNUM/$MSTDIR
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI98,$HOSPNUM
        exit 99
    fi
    if  [  -s	$HOME/$HOSPNUM/$MSTDIR/$KANRIFILE	]
    then
	echo "センタからのDBレコード管理情報は正常でした"
    else
	echo "センタからのDBレコード管理情報は空でした"
	rm -r $HOME/$HOSPNUM/$MSTDIR
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI01,$HOSPNUM
        exit 99
    fi
fi

#ダウンロードファイル生成
	$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCXRMST3 -parameter $HOSPNUM$2$MSTDIR
	if [ $? -ne 0 ]	;	then 
		echo "ダウンロードファイル生成に失敗しました"
		$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
		exit 99
	fi
#更新用ダウンロードファイル受信
#ファイルサイズチェック
	if [	-s	$UPDFILE	]
	then
		echo "更新用ダウンロードファイルの作成が終了しました"
	else
		echo "更新用ダウンロードファイルの作成に失敗しました"
		$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI01,$HOSPNUM
		rm -r $HOME/$HOSPNUM/$MSTDIR
		exit 99
	fi

UPDLIST=`awk '{gsub(/\t| |;/,""); print} ' $UPDFILE`

for UPD in $UPDLIST
do
	echo ${UPD:34:$LEN}
	if  [ $OFFLINE = "offline" ]; then
	    if  [ -e $OFFLINEPATH/${UPD:34:$LEN} ]; then
		cp $OFFLINEPATH/${UPD:34:$LEN} ./
		echo ${UPD:34:$LEN} "複写が終了しました"
	    else
		echo ${UPD:34:$LEN} "複写に失敗しました"
		$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
	        exit 99
	    fi
	else
	    if	orcawget ${UPD:34:$LEN} ;	then
		echo ${UPD:34:$LEN} "ダウンロードが終了しました"
	    else
		echo ${UPD:34:$LEN} "ダウンロードに失敗しました"
		$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
	        exit 99
	    fi
	fi
done

for UPD in $UPDLIST
do
#	echo $UPD
	if	orcatar $UPD ;	then
		echo $UPD "解凍処理が終了しました"
	else
		$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
		echo $UPD "解凍処理に失敗しました"
	        exit 99
	fi
done
#DB構造変更処理
for UPD in $UPDLIST
do
	UPD1=`echo $UPD | awk '{gsub(/.tar.gz/,".dat"); print} ' `
	echo $UPD1 "DB更新"
#ダウンロードファイル生成
	$DBSTUB  -dir $LDDIRECTORY -bd orcabt ORCXRMST4 -parameter $HOSPNUM$MSTDIR$UPD1*****************************************************
	echo $?
	if [ $? -ne 0 ]	;	then 
		echo $UDP1 "更新処理に失敗しました"
		$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI99,$HOSPNUM
		exit 99
	fi
done

echo  "全ての処理が完了しました"
rm -r $HOME/$HOSPNUM/$MSTDIR
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001MSTMLI00,$HOSPNUM
