#!/bin/bash

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

umask 022

#------------------------------------
# $1 : 処理区分
# $2 : 医療機関識別番号(HOSPNUM)
# $3 : スーパーバイザー
#------------------------------------

HOSPNUM=$2

HOME=/home/orca
PRGDIR=orca-prg@VERSION@
PATCHDIR=/var/lib/jma-receipt/patch
LOGDIR=/var/log/jma-receipt
PACKAGEFILE=patch@VERSION@.gz

PRGPATH=$PGUPGRADEPATH/@VERSION@

LOG="$LOGDIR"/program_upgrade_online.log

CACERTFILE=/etc/ssl/certs/orca-project-ca-1.crt

# echo message (default character-code EUC)
echomsg() {
  if [ "${LANG}" = "ja_JP.UTF-8" ] || [ "${LANG}" = "ja_JP.UTF8" ]; then
    echo `echo $1 | nkf -wE | tee -a $2`
  else
    echo $1 | tee -a $2
  fi
}

rm -f ${LOG}

#オフラインメンテナンスであるかチェック
OFFLINEPATH=`echo $PRGPATH | sed -ne 's#file://##p'`
if [ -z $OFFLINEPATH ]; then
  OFFLINE="online"
else
  OFFLINE="offline"
  PRGPATH=$OFFLINEPATH
fi
echomsg ${OFFLINE} ${LOG}

#旧方式か？
if [ -n	"$OBSOLETEDL" ]; then
  OBSDL=yes
else
  OBSDL=no
fi

if ! [ -d $HOME/$PRGDIR ]; then 
  cd $HOME
  mkdir $PRGDIR
fi
cd $HOME/$PRGDIR
rm -f $HOME/$PRGDIR/*

#更新プログラムダウンロード
ruby $SCRIPTSDIR/allways/cachedl.rb $PACKAGEFILE $PATCHDIR $PRGPATH $OFFLINE $CACERTFILE $OBSDL $WGETOPTION
if [ $? -ne 0 ] ; then
  echomsg "更新プログラムのダウンロードに失敗しました" ${LOG}
  rm -rf $HOME/$PRGDIR
  $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01,$HOSPNUM
  exit 99
fi

#プログラム更新処理
ruby $SCRIPTSDIR/allways/program_upgrade_exec.rb $PACKAGEFILE $PATCHDIR $HOME/$PRGDIR
if [ $? -ne 0 ] ; then
  echomsg "更新プログラムの処理に失敗しました" ${LOG}
  rm -rf $HOME/$PRGDIR
  $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99,$HOSPNUM
  exit 99
fi

rm -rf $HOME/$PRGDIR

bash $SCRIPTSDIR/allways/program_upgrade_check.sh $HOSPNUM $3

#monitor再起動（ＳＩＧＨＵＰ）
if [ -e /var/run/jma-receipt/monitor.pid ]; then
  echomsg "monitorの再起動を行います" ${LOG}
  kill -HUP `cat /var/run/jma-receipt/monitor.pid`
else
  echomsg "monitor.pidファイルがありませんので再起動はしません" ${LOG}
fi

echomsg "全ての処理が完了しました" ${LOG}

#$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00,$HOSPNUM
