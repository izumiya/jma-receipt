#!/bin/sh

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

umask 022

HOME=/home/orca
PRGDIR=orca-prg@VERSION@
PRGCFILE=ORCAPGC.DAT
PGKUPDCNTFILE=PGKANRIUPDCNT.DAT
UPDFILE=/home/orca/$PRGDIR/ORCAPGC.OUT
RSTFILE=/home/orca/$PRGDIR/RESTART
PATCHDIR=/var/lib/jma-receipt/patch
PACKAGEFILE=patch@VERSION@.gz

PRGPATH=$PGUPGRADEPATH/@VERSION@

#オフラインメンテナンスであるかチェック
OFFLINEPATH=`echo $PRGPATH | sed -ne 's#file://##p'`
if [ -z $OFFLINEPATH ]; then
    OFFLINE="online"
else
    OFFLINE="offline"
    PRGPATH=$OFFLINEPATH
fi

if ! [	-d	$HOME/$PRGDIR	];	then 
	cd $HOME
	mkdir $PRGDIR
fi
cd $HOME/$PRGDIR
rm -f *.*

#更新プログラムダウンロード
ruby $SCRIPTSDIR/allways/cachedl.rb $PACKAGEFILE $PATCHDIR $PRGPATH $OFFLINE $WGETOPTION
if  [ $? -ne 0 ] ; then
    echo "更新プログラムのダウンロードに失敗しました"
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01
    exit 99
fi

#アーカイブよりパッチプログラムを複写
ruby $SCRIPTSDIR/allways/cachetoprgdir.rb $PACKAGEFILE $PATCHDIR $HOME/$PRGDIR
if  [ $? -ne 0 ] ; then
    echo "更新プログラムの複写に失敗しました"
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01
    exit 99
fi
if ! [ -e $HOME/$PRGDIR/$PRGCFILE ];	then
    echo "プログラム管理ファイルが存在しません"
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01
    exit 99
fi

#プログラム管理テーブル更新
$DBSTUB  -noredirect -dir $LDDIRECTORY -bd orcabt ORCXPMNT1 -parameter $HOME/$PRGDIR/$PRGCFILE,$HOME/$PRGDIR/$PGKUPDCNTFILE
if [ $? -ne 0 ]	;	then 
    echo "プログラム管理テーブルの更新に失敗しました"
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
    exit 99
else
    if ! [ -e $HOME/$PRGDIR/$PGKUPDCNTFILE ];	then
	echo "プログラム管理テーブル更新件数ファイルが存在しません"
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
	exit 99
    else
	if [ `cat $HOME/$PRGDIR/$PGKUPDCNTFILE` -eq "0000" ];	then
	    echo "プログラム管理テーブル更新件数は０件でした"
	    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT01
	    exit 99
	fi
    fi
fi

#情報取得のみの場合終了
if [ $1 = "1" ];	then
    rm -r $HOME/$PRGDIR
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00
    exit
fi

#プログラム更新処理
$DBSTUB  -noredirect -dir $LDDIRECTORY -bd orcabt ORCXPMNT3 -parameter $RSTFILE,$HOME/$PRGDIR
if [ $? -ne 0 ]	;	then 
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
    exit 99
fi

sleep 3

echo  "全ての処理が完了しました"

#rm -r $HOME/$PRGDIR
$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00
