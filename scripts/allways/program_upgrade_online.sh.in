#!/bin/sh

if test -z "$JMARECEIPT_ENV"; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

umask 022

HOME=/home/orca
PRGDIR=orca-prg@VERSION@
PRGCFILE=ORCAPGC.DAT
UPDFILE=/home/orca/$PRGDIR/ORCAPGC.OUT
RSTFILE=/home/orca/$PRGDIR/RESTART
CACHE_DIR=/var/lib/jma-receipt/cache/patch
PACKAGEFILE=patch@VERSION@.gz

FTP=$PGUPGRADEPATH/@VERSION@

#更新プログラムダウンロード
ruby $SCRIPTSDIR/allways/cachedl.rb $PACKAGEFILE $CACHE_DIR $FTP

if ! [	-d	$HOME/$PRGDIR	];	then 
	cd $HOME
	mkdir $PRGDIR
fi
cd $HOME/$PRGDIR
rm -f *.*

#アーカイブよりパッチプログラムを複写
ruby $SCRIPTSDIR/allways/cachetoprgdir.rb $PACKAGEFILE $CACHE_DIR $HOME/$PRGDIR

if ! [ -e $HOME/$PRGDIR/$PRGCFILE ];	then
	echo "プログラム管理ファイルが存在しません"
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
	exit 99
fi

#プログラム管理テーブル更新
	$DBSTUB  -noredirect -dir $LDDIRECTORY -bd orcabt ORCXPMNT1 -parameter $HOME/$PRGDIR/$PRGCFILE
	if [ $? -ne 0 ]	;	then 
		echo "プログラム管理テーブルの更新に失敗しました"
		$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
		exit 99
	fi

#情報取得のみの場合終了
if [ $1 = "1" ];	then
	rm -r $HOME/$PRGDIR
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00
	exit
fi

#プログラム更新処理
	$DBSTUB  -noredirect -dir $LDDIRECTORY -bd orcabt ORCXPMNT3 -parameter $RSTFILE,$HOME/$PRGDIR
	if [ $? -ne 0 ]	;	then 
		$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT99
		exit 99
	fi

sleep 3

echo  "全ての処理が完了しました"

#rm -r $HOME/$PRGDIR
	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE0000001PRGMNT00
