#!/bin/bash

JMARECEIPT_ENV="@jma-receipt-env@"
if [ ! -f ${JMARECEIPT_ENV} ]; then
    echo "${JMARECEIPT_ENV} does not found."
    exit 1
fi
. $JMARECEIPT_ENV

#------------------------------------
# $1 : 処理区分
# $2 : プログラム名
# $3 : インストールディレクトリ
#------------------------------------

PRGDIR=orca-prgupwork

LOG="$LOGDIR"/program_upgrade_check.log

SYORI=$1
PGNAME=$2
INSTALLDIR=$3

case "${SYORI}" in
  clear)
      SQL="\set ON_ERROR_STOP
      begin;
      delete from tbl_pgkanri where systemversion = 'check';
      commit;"
      create_pgpass
      echo "${SQL}" | psql ${DBCONNOPTION} ${DBNAME}
      delete_pgpass
      exit 0
      ;;

  complete)
      COMMENT="提供されている最新の状態でした。"
      UPDATEFLG=""
      ;;

  error1)
      COMMENT="${PGNAME} が提供されていますが適用されていません。"
      UPDATEFLG="E"
      ;;

  error2)
      COMMENT="${INSTALLDIR}/${PGNAME} がありますが提供されたものではありません。"
      UPDATEFLG="E"
      ;;

  error3)
      COMMENT="${INSTALLDIR}/${PGNAME} は提供されたものと内容が違います。"
      UPDATEFLG="E"
      ;;

  error4)
      COMMENT="${INSTALLDIR}/${PGNAME} は提供されたものと違う場所にあります。"
      UPDATEFLG="E"
      ;;

  error9)
      COMMENT="${INSTALLDIR}/${PGNAME} ？？"
      UPDATEFLG="E"
      ;;

  *)
      COMMENT=""
      UPDATEFLG=""
      ;;
esac

ymd=$(date +'%Y%m%d')
time=$(date +'%H%M%S')

SQL="select max(pgno) from tbl_pgkanri;"
create_pgpass
PGNOMAX=`echo ${SQL} | psql ${DBCONNOPTION} -t -A ${DBNAME}`
if [ -z ${PGNOMAX} ]; then
  PGNOMAX=000
fi
WKNUM=`expr ${PGNOMAX} + 1`
PGNO=`printf "%03d" ${WKNUM}`

SQL="\set ON_ERROR_STOP
begin;
SELECT
 CASE pg_encoding_to_char(encoding)
  WHEN 'UTF8' THEN set_config('client_encoding','EUC_JIS_2004',true)
  WHEN 'EUC_JP' THEN set_config('client_encoding','EUC_JP',true)
  ELSE set_config('client_encoding','EUC_JP',true)
 END as encode
FROM
 pg_database
WHERE
 datname = current_database();
insert into tbl_pgkanri values ('','check','${PGNO}','${ymd}','${PGNAME}','${UPDATEFLG}','','${INSTALLDIR}','${COMMENT}','','','${ymd}','','${time}');
commit;"

echo "${SQL}" | psql ${DBCONNOPTION} ${DBNAME}
delete_pgpass

exit 0
