#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    レセ電ファイル作成処理
#        $1-${11} 印刷ＤＢ用固定引数
#        $12 提出先
#        $13 レセ電ファイル出力先
#        $14 JOBID 
#        $15 SHELLID
#        $16 エラーファイル名 
#        $17 ファイル出力先区分
#        $18 端末ｉｐアドレス
#        $19 入外区分
#        ${20} HOSPNUM
#        ${21} レセプト作成区分
#            1:提出用レセ、2:点検用レセ
#-------------------------------------------#

    rennum=0
##  2HD flesize  
    fixedsize=1441500

##  エラーファイル削除
	echo $#
	echo "echo " ${16}
    if  [ -e ${16} ]; then
        rm ${16}
    fi

        rm -f /home/orca/recept4.log
        LOG_FILE="/var/log/jma-receipt/${20}recept4.log"

        echo "arg13 = [" ${13} "]"  >$LOG_FILE
        echo "arg18 = [" ${18} "]" >>$LOG_FILE
        echo "hostname =  [" `hostname`  "]" >>$LOG_FILE

#   該当ファイル削除
	rm ${13}${20}RECEIPTC*.UKE
	rm /tmp/${20}RECEDEN*.txt

#   レセ電ファイル作成

    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBM500 -parameter $1,$2,$3,$rennum,$5,$6,$7,$8,$9,${10},${11},${12},${13},${14},${15},${19},${17},$fixedsize,${21},${20},${16} >> $LOG_FILE 2>&1
    if  [ -e ${16} ]; then
        echo "--- BM500 err file exist ---" >> $LOG_FILE 2>&1
        exit 
    fi
        
#   症状詳記作成

    rennum=$(expr $rennum + 1) 
    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBM510 -parameter $1,$2,$3,$rennum,$5,$6,$7,$8,$9,${10},${11},${12},${14},${15},${19},${20},${16} >> $LOG_FILE 2>&1
        
        
    if  [ -e ${16} ]; then
        echo "--- BM510 err file exist ---" >>$LOG_FILE
        exit 
    fi
        

#   漢字コード変換（ＥＵＣからシフトＪＩＳ）	

	NUM=0
    while [ $NUM -lt 100 ]
    do
        NUM=`expr $NUM + 1`
        FILENUM='0'$NUM
    	    echo "filenum"
            echo  ${FILENUM:${#FILENUM}-2:2}
	    if  test -s "/tmp/${20}RECEDEN${FILENUM:${#FILENUM}-2:2}.txt"; then
    	    echo ${FILENUM:${#FILENUM}-2:2}
	    else
    	    echo ${FILENUM:${#FILENUM}-2:2} "nothing"
		    break
	    fi
	    if  test "${FILENUM:${#FILENUM}-2:2}"	=	"01"; then
		    echo "先頭ファイルの処理(sjis変換)"
		    nkf -s /tmp/${20}RECEDEN${FILENUM:${#FILENUM}-2:2}.txt > ${13}${20}RECEIPTC.UKE
	    else
		    echo "２番目以降のファイルの処理(sjis変換)"
		    nkf -s /tmp/${20}RECEDEN${FILENUM:${#FILENUM}-2:2}.txt > ${13}${20}RECEIPTC${FILENUM:${#FILENUM}-2:2}.UKE
	    fi
    done

#   先頭ファイルのみ処理 

    if  [ -e ${13}${20}RECEIPTC.UKE ]; then
        echo "--- RECEIPTC.UKE exist ---" >>$LOG_FILE
    fi
    FDDHOST=`echo ${18}|tr \[\] "  "`
    echo "FDDHOST = " $FDDHOST
##
		    echo "先頭ファイルの処理(fdw処理)" ${13}${20}RECEIPTC.UKE
##    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${14}${15}
##    exit 
##
    if  [ ${17} -eq '1' ]; then
        echo "--- fdw-> fd start ---" >>$LOG_FILE
	$FDW -host $FDDHOST -command fd-write.sh ${13}${20}RECEIPTC.UKE RECEIPTC.UKE
	RC=$?
        echo "--- fdw-> fd end   ---[" $RC  "]" >>$LOG_FILE
	if  [ $RC -ne '0' ]; then
	    ERRCD='0000'$RC
	    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${14}${15}'  '${ERRCD:${#ERRCD}-4:4},${20} >> $LOG_FILE
        echo "--- fdw-> fd err   ---" >>$LOG_FILE
            exit
	fi
    fi

    if  [ ${17} -eq '2' ]; then
        echo "--- fdw-> mo start ---" >>$LOG_FILE
	$FDW -host $FDDHOST -command mo-write.sh ${13}${20}RECEIPTC.UKE RECEIPTC.UKE
	RC=$?
        echo "--- fdw-> mo end   ---[" $RC  "]" >>$LOG_FILE
	if  [ $RC -ne '0' ]; then
	    ERRCD='0000'$RC
	    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${14}${15}'  '${ERRCD:${#ERRCD}-4:4},${20} >> $LOG_FILE
            echo "--- fdw-> mo err   ---" >>$LOG_FILE
            exit
	fi
    fi

    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${14}${15},${20} >> $LOG_FILE

    exit 
