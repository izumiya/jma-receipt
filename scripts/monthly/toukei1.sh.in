#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

#-------------------------------------------#
#    月次統計データ作成
#        $1  TERMID 
#        $2  HOSPID
#        $3  HPSPCD   
#        $4  県番号
#        $5  SRYYM 
#        $6  NYUGAIKBN 
#        $7  FILENM1
#        $8  FILENM2 
#        $9  DATAKBN
#        ${10} HOUKATUKBN
#        ${11} KOJINKBN
#        ${12} CDKBN
#        ${13} JOBID
#        ${14} SHELLID
#        ${15} ERRFILENM
#        ${16} ファイル出力先区分（診療）
#        ${17} ファイル出力先区分（病名）
#        ${18} 端末ｉｐアドレス
#        ${19} HOSPNUM
#        ${20} FILENM1 FOLDER
#        ${21} FILENM2 FOLDER
#-------------------------------------------#

        LOG_FILE="/var/log/jma-receipt/${19}toukei1.log"

        echo "arg7  = [" ${7}  "]" >$LOG_FILE
        echo "arg8  = [" ${8}  "]" >>$LOG_FILE
        echo "arg12 = [" ${12} "]" >>$LOG_FILE
        echo "arg15 = [" ${15} "]" >>$LOG_FILE
        echo "arg16 = [" ${16} "]" >>$LOG_FILE
        echo "arg17 = [" ${17} "]" >>$LOG_FILE
        echo "arg18 = [" ${18} "]" >>$LOG_FILE
        echo "arg19 = [" ${19} "]" >>$LOG_FILE
        echo "arg20 = [" ${20} "]" >>$LOG_FILE
        echo "arg21 = [" ${21} "]" >>$LOG_FILE

##      エラーファイル削除
	echo "errfile = [" ${MCP_TEMPDIR}/${15}  "]" >> $LOG_FILE
        rm  -f ${MCP_TEMPDIR}/${15}

        rm  -f ${MCP_TEMPDIR}/${19}TOKEI0*

        
	    $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBT010 -parameter $1,$2,$4,$5,$6,$9,${10},${13},${14},${19},${15} >> $LOG_FILE 2>&1
        
        if  [ -e ${MCP_TEMPDIR}/${15} ]; then
            exit 
        else
	        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBT020 -parameter $2,$3,$5,$1,$9,${11},${13},${14},${19},${15},${7},${8},${16},${17},${20},${21} >> $LOG_FILE 2>&1
	fi

        if  [ -e ${MCP_TEMPDIR}/${15} ]; then
            exit 
	fi

#       漢字コード変換（ＥＵＣからシフトＪＩＳ）

        if  [ ${12} -eq '2' ]; then
            if   [ ${9} != '2' ]; then
                nkf -s -Lw ${MCP_TEMPDIR}/${19}toukei01.dat > ${MCP_TEMPDIR}/$7
            fi 
            if   [ ${9} != '1' ]; then
                nkf -s -Lw ${MCP_TEMPDIR}/${19}toukei02.dat > ${MCP_TEMPDIR}/$8
            fi 
        else
            if   [ ${9} != '2' ]; then
                cp  ${MCP_TEMPDIR}/${19}toukei01.dat ${MCP_TEMPDIR}/$7
            fi 
            if   [ ${9} != '1' ]; then
                cp  ${MCP_TEMPDIR}/${19}toukei02.dat ${MCP_TEMPDIR}/$8
            fi
        fi
#
    FDDHOST=`echo ${18}|tr \[\] "  "`
        if   ( [ ${9} != '2' ] && [ ${16} != '6' ] ); then
             case ${16} in
                  3) 	$FDW -host $FDDHOST -command user1-write.sh${MCP_TEMPDIR}/$7 $7
			RC=$?
                        ;;
                  4) 	$FDW -host $FDDHOST -command user2-write.sh ${MCP_TEMPDIR}/$7 $7
			RC=$?
                        ;;
                  5) 	$FDW -host $FDDHOST -command user3-write.sh ${MCP_TEMPDIR}/$7 $7
			RC=$?
                        ;;
             esac
	     if  [ $RC -ne '0' ]; then
		ERRCD='0000'$RC
        	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${13}${14}${ERRCD:${#ERRCD}-4:4},${19} >> $LOG_FILE 2>&1
		exit
	     fi
        fi         
        if   ( [ ${9} != '1' ] && [ ${17} != '6' ] ); then
             case ${17} in
                  3) 	$FDW -host $FDDHOST -command user1-write.sh ${MCP_TEMPDIR}/$8 $8
			RC=$?
                        ;;
                  4) 	$FDW -host $FDDHOST -command user2-write.sh ${MCP_TEMPDIR}/$8 $8
			RC=$?
                        ;;
                  5) 	$FDW -host $FDDHOST -command user3-write.sh ${MCP_TEMPDIR}/$8 $8
			RC=$?
                        ;;
             esac
	     if  [ $RC -ne '0' ]; then
		ERRCD='0000'$RC
        	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${13}${14}${ERRCD:${#ERRCD}-4:4},${19} >> $LOG_FILE 2>&1
		exit
	     fi
        fi         

        $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOB -parameter JBE${13}${14},${19} >> $LOG_FILE 2>&1

        exit 
