#!/bin/sh

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

HOSPNUM=$1

export CLIENT_CONFIG_FILE="$SYSCONFDIR/das-upload.d/das-upload${HOSPNUM}.conf"
if [ ! -f $CLIENT_CONFIG_FILE ]; then
    exit
fi

FILE_PREFIX="collect-"
UPLOAD_COMMAND=`dirname $0`/das-upload.rb
LOGFILE=/var/log/jma-receipt/"$HOSPNUM"datacollect1.log

for file in `ls "$DASDIR"/"$HOSPNUM"/"$FILE_PREFIX"*tar.gz 2>/dev/null`
do
  UPTARGEFILE=1
  OBJECTYYM=`basename $file |sed -e "s/${FILE_PREFIX}\(.*\).tar.gz/\1/"`
  RESULT=`$UPLOAD_COMMAND $file 2>&1|head -1`
  if [ "UP $file" = "$RESULT" ]; then
     echo "000" $RESULT
     $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOBLOG -parameter "das-upload","2","0",$OBJECTYYM,"000","Upload success",$HOSPNUM 2>&1 | tee -a $LOGFILE
     rm $file
  else
     $DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBJOBLOG -parameter "das-upload","2","1",$OBJECTYYM,"${RESULT:0:3}","${RESULT:4}",$HOSPNUM 2>&1 | tee -a $LOGFILE
     echo "${RESULT:0:3}","${RESULT:4}"
  fi
done

if [ x$UPTARGEFILE != "x1" ]; then
  RESULT="900 No file"
  echo "${RESULT:0:3}","${RESULT:4}"
fi
