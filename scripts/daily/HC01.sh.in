#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV

export HOME=/home/orca
printf %-20000s "$(cat $4)" > $4.tmp
mv $4.tmp $4

[[ $(cat $4) =~ MonpeLayerIn(.*)MonpeLayerOut ]]
LAYEROPTION=$(echo " ${BASH_REMATCH[1]}" | sed -e "s/ *-L */,/g" | sed -e "s/,/-H /")
sed -i -e "s/${BASH_REMATCH[0]}/$(printf %-$(expr length "${BASH_REMATCH[0]}")s ' ')/"  $4

#
#-------> path switch st
file=`basename ${2}`
patch_file=$PATCHFORMDIR/$file
normal_file=$FORMDIR/$file
site_file=$SITEFORMDIR/$file
usr_form=$2

if ! test -f $site_file
then
  if test -f $patch_file
  then
    usr_form=$patch_file
  fi
fi
#-------> path switch ed
#whether encoding is utf-8 or not.
if [ "$8"  == '2' ]; then
	export	RED2PS_OUTPUT_CHARSET=UTF-8
else
	export	RED2PS_OUTPUT_CHARSET=EUC-JP
fi
	if	[ $1 = 'red2ps' ];then
		RED2IFILE=$4.red2
		PDFFILE=$4.pdf
		FILE=$4.pdf
		PRINTER=$5
		OFFSETX=$6
		OFFSETY=$7

		[ -z $PRINTER  ] && PRINTER=lp1
		[ -z $OFFSETX  ] && OFFSETX=0
		[ -z $OFFSETY  ] && OFFSETY=0

		red2embed $usr_form $4 -o $RED2IFILE
		monpe $LAYEROPTION -x $OFFSETX -y $OFFSETY $RED2IFILE -e $PDFFILE
	 	lpr -P $PRINTER $PDFFILE

		[ -e $RED2IFILE ] && rm $RED2IFILE
		[ -e $PDFFILE ]   && rm $PDFFILE
	else	
		%RUBY% $1 $2 $3 $4 $5
	fi
#----------------------------------------------------------------------#
#	ファイル削除処理
#----------------------------------------------------------------------#
HCLIST="HC04 HC08 HC18 HC20 HC21 HC22 HC23 HC24"
  for FL in $HCLIST
  do
	if	[ $FL = ${4:9:4} ]	;then
                 echo ${4:9:4}
		exit
	fi
  done
  if [ -e $4 ]	;then
        echo $4
#------ 処方せんQRイメージ削除
	if	[ ${4:7:4} = "HC2Q" ]	;then
	    %RUBY% -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' $4 | xargs rm -f
	fi
	if	[ ${4:7:4} = "HC62" ]	;then
	    %RUBY% -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' $4 | xargs rm -f
	fi
	rm $4
  fi
#----------------------------------------------------------------------#
#	終了処理
#----------------------------------------------------------------------#
	echo "The end"
exit $RET
