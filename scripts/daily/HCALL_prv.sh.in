#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV
export HOME=/home/orca
export PATH=$SITESCRIPTSDIR/daily:$PATCHSCRIPTSDIR/daily:$SCRIPTSDIR/daily:$PATH

#----------------------------------------------------------------------#
#       引数	
#       1:DATAファイル名称
#       2:HOSPNUM
#       3:エンコーディング(1:EUC-JP/2:UTF8/3:OTHER)
#       4:DATAファイル名称(オリジナル)
#----------------------------------------------------------------------#

echo	`date`
echo $#

PRT_FILE_BASE=$1
PRT_FILE_FULL=${MCP_TEMPDIR}/${PRT_FILE_BASE}

ORG_FILE_BASE=$4
ORG_FILE_FULL=${MCP_TEMPDIR}/${ORG_FILE_BASE}

print_parent_prv.rb ${PRT_FILE_FULL} ${FORMDIR} ${RECORDDIR} ${SITEFORMDIR} ${SITERECORDDIR} ${PATCHFORMDIR}
if	[ $?  -eq  0 ]; then
       	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBPREV -parameter ${PRT_FILE_BASE},$2
fi

rm -f ${PRT_FILE_FULL}

if [ -z "${ORG_FILE_BASE}" ]  ; then
	echo "HCALL end"
	exit
fi

if [ $dirname(${ORG_FILE_FULL}) = ${MCP_TEMPDIR} ] ; then
#------ 処方せんQRイメージ削除
	if      [[ ${ORG_FILE_FULL} =~ ^${MCP_TEMPDIR}/..HC2Q ]]   ;then
		grep -Eo "${MCP_TEMPDIR}.*\.png" ${ORG_FILE_FULL} | sed -e "s/ \+/ /" | xargs rm -f
	fi
	if      [[ ${ORG_FILE_FULL} =~ ^${MCP_TEMPDIR}/..HC62 ]]   ;then
                LDATA=`ls \`echo ${ORG_FILE_FULL} | sed 's/[[:digit:]]*\.dat$//g'\`* | sort -r | head -n 1`
		grep -Eo "${MCP_TEMPDIR}.*\.png" ${LDATA} | sed -e "s/ \+/ /" | xargs rm -f
	fi
	rm ${ORG_FILE_FULL:0:$(expr ${#ORG_FILE_FULL} - 10 )}*
	rm ${PRT_FILE_FULL:0:$(expr ${#PRT_FILE_FULL} - 10 )}*
fi

	echo	`date`
