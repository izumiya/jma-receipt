#!/bin/bash

if test -z "$JMARECEIPT_ENV" ; then
    JMARECEIPT_ENV="@jma-receipt-env@"
fi
if ! test -f "$JMARECEIPT_ENV"; then
    exit 0
fi

. $JMARECEIPT_ENV
export HOME=/home/orca

#if ! test -d /var/tmp/.orca_ps ; then
#    mkdir /var/tmp/.orca_ps
#fi

#----------------------------------------------------------------------#
#       引数	
#       1:DATAファイル名称
#       2:HOSPNUM
#       3:エンコーディング(1:EUC-JP/2:UTF8/3:OTHER)
#       4:DATAファイル名称(オリジナル)
#----------------------------------------------------------------------#

	echo	`date`
	echo $#
	echo	$1

	ruby "$SCRIPTSDIR"/daily/print_parent_prv.rb "/var/tmp/temp.tmp" "ruby ${SCRIPTSDIR}/daily/print-data.rb " ${FORMDIR} ${RECORDDIR} ${SITEFORMDIR} ${SITERECORDDIR} $1 "ruby ${SCRIPTSDIR}/daily/print-data_prv.rb " ${PATCHFORMDIR}

	if	[ $?  =  0 ]; then
        	$DBSTUB -dir $LDDIRECTORY -bd orcabt ORCBPREV -parameter $1,$2
	fi
	rm -f $1
        if [ -z "$4" ]  ; then
                echo "HCALL end"
                exit
        fi
        if [ ${4:0:4} = "/tmp" ] ; then
#------ 処方せんQRイメージ削除
	if      [ ${4:7:4} = "HC2Q" ]   ;then
		ruby -ne '$_.scan(%r|/tmp.*?\.png|m){|a| print "#{a} "}' ${4} | xargs rm -f
	fi
	rm ${4}
	fi

	echo	`date`
